# PhoneContactsModal - Documentaci√≥n Completa

## üìã Descripci√≥n General

`PhoneContactsModal` es un componente que permite a los usuarios ver sus contactos telef√≥nicos y determinar cu√°les de ellos est√°n registrados en la plataforma. El componente compara los n√∫meros de tel√©fono locales con los usuarios registrados y permite iniciar conversaciones o invitar contactos que no est√°n en la plataforma.

---

## üéØ Caracter√≠sticas Principales

1. **Acceso a contactos del dispositivo** mediante permisos nativos
2. **Comparaci√≥n inteligente** de n√∫meros de tel√©fono (normalizaci√≥n)
3. **Cach√© local** con AsyncStorage para mejorar rendimiento (24h de expiraci√≥n)
4. **Actualizaci√≥n en segundo plano** mientras se muestra cach√©
5. **L√≥gica de permisos de chat** entre diferentes tipos de usuarios
6. **Invitaci√≥n** de contactos no registrados v√≠a WhatsApp/SMS
7. **B√∫squeda y filtrado** de contactos
8. **Animaciones suaves** con entrada desde abajo

---

## üì¶ Librer√≠as Necesarias

### Instalaci√≥n

```bash
# Expo Contacts - Para acceder a contactos del tel√©fono
npx expo install expo-contacts

# AsyncStorage - Para almacenar cach√© local
npx expo install @react-native-async-storage/async-storage

# Expo Icons - Para iconos (ya incluido en Expo)
npx expo install @expo/vector-icons

# React Native - Componentes nativos base
# (Ya incluido en React Native / Expo)
```

### Dependencias en package.json

```json
{
  "dependencies": {
    "expo-contacts": "~14.0.0",
    "@react-native-async-storage/async-storage": "1.23.1",
    "@expo/vector-icons": "^14.0.0",
    "react-native": "0.74.5"
  }
}
```

---

## üîë Permisos Requeridos

### Android (`android/app/src/main/AndroidManifest.xml`)

```xml
<manifest>
  <uses-permission android:name="android.permission.READ_CONTACTS" />
  <uses-permission android:name="android.permission.WRITE_CONTACTS" />
</manifest>
```

### iOS (`ios/YourApp/Info.plist`)

```xml
<key>NSContactsUsageDescription</key>
<string>Necesitamos acceso a tus contactos para mostrarte qui√©nes est√°n en la plataforma</string>
```

### Solicitud en Runtime

```typescript
import * as Contacts from 'expo-contacts';

const { status } = await Contacts.requestPermissionsAsync();
if (status === 'granted') {
  // Acceso concedido
} else {
  // Mostrar mensaje y opci√≥n para ir a configuraci√≥n
  Linking.openSettings();
}
```

---

## üîÑ Flujo de Funcionamiento

### 1. **Apertura del Modal**

```
Usuario abre modal
    ‚Üì
Animar entrada desde abajo (slideAnim)
    ‚Üì
Llamar a loadContacts()
```

### 2. **Carga de Contactos (loadContacts)**

```
Intentar cargar desde cach√©
    ‚Üì
¬øCach√© existe y es v√°lido? (< 24h)
    ‚îú‚îÄ‚îÄ S√ç ‚Üí Mostrar contactos cacheados
    ‚îÇ         ‚Üì
    ‚îÇ   Actualizar en segundo plano (updateContactsInBackground)
    ‚îÇ
    ‚îî‚îÄ‚îÄ NO ‚Üí Mostrar loading
              ‚Üì
          Solicitar permisos
              ‚Üì
          Obtener contactos del tel√©fono
              ‚Üì
          Obtener usuarios de la plataforma (API)
              ‚Üì
          Comparar y hacer matching
              ‚Üì
          Guardar en cach√©
              ‚Üì
          Mostrar resultados
```

---

## üì± Obtenci√≥n de Contactos del Tel√©fono

```typescript
// Solicitar permisos
const { status } = await Contacts.requestPermissionsAsync();

if (status === 'granted') {
  // Obtener contactos con campos espec√≠ficos
  const { data } = await Contacts.getContactsAsync({
    fields: [
      Contacts.Fields.PhoneNumbers,  // N√∫meros de tel√©fono
      Contacts.Fields.Image,          // Avatar (si existe)
    ],
  });

  // data contiene array de contactos
  console.log('Total contactos:', data.length);
}
```

### Estructura de un Contacto

```typescript
{
  id: string;
  name: string;
  phoneNumbers: Array<{
    id: string;
    number: string;
    digits?: string;
    label: string;
  }>;
  imageAvailable: boolean;
}
```

---

## üîÄ Normalizaci√≥n de N√∫meros de Tel√©fono

La normalizaci√≥n es **cr√≠tica** para comparar n√∫meros correctamente, ya que pueden venir en diferentes formatos.

### Ejemplos de Formatos

```
(312) 456-7890
312-456-7890
+57 312 456 7890
573124567890
3124567890
```

### Funci√≥n de Normalizaci√≥n

```typescript
const normalizePhoneNumber = (phone: string): string => {
  // 1. Eliminar todo excepto n√∫meros
  let normalized = phone.replace(/\D/g, '');
  
  // 2. Si tiene 10 d√≠gitos, agregar c√≥digo de pa√≠s
  if (normalized.length === 10) {
    // Ajustar seg√∫n pa√≠s (ej: 57 para Colombia)
    normalized = '57' + normalized;
  }
  
  // 3. Retornar n√∫mero normalizado
  return normalized;
};
```

### Aplicaci√≥n

```typescript
// Normalizar n√∫meros del contacto local
const normalizedPhones = contact.phoneNumbers!.map(pn => 
  normalizePhoneNumber(pn.number || '')
);

// Normalizar n√∫mero del usuario de la plataforma
const userPhone = normalizePhoneNumber(user.telefono || '');

// Comparar
if (normalizedPhones.includes(userPhone)) {
  // ¬°Coincidencia encontrada!
}
```

---

## üåê Obtenci√≥n de Usuarios de la Plataforma

### API Call Example

```typescript
// En ChatService.ts o similar
async getAvailableContacts(): Promise<Contact[]> {
  try {
    const response = await fetch(`${API_URL}/api/chat/contacts`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    return data.contacts;
  } catch (error) {
    console.error('Error obteniendo contactos:', error);
    return [];
  }
}
```

### Estructura del Objeto Contact

```typescript
interface Contact {
  userId: number;
  nombre: string;
  telefono: string;
  rol: 'proveedor' | 'comerciante' | 'admin';
  logo_url?: string | null;
  canChat: boolean;  // ‚Üê Importante para l√≥gica de permisos
}
```

---

## üîó Comparaci√≥n y Matching

### L√≥gica de Comparaci√≥n

```typescript
const matched: MatchedContact[] = phoneContacts
  .filter(contact => contact.phoneNumbers && contact.phoneNumbers.length > 0)
  .map(contact => {
    // Normalizar todos los n√∫meros del contacto
    const normalizedPhones = contact.phoneNumbers!.map(pn => 
      normalizePhoneNumber(pn.number || '')
    );

    // Buscar coincidencia con usuarios de la plataforma
    const platformUser = platformUsers.find(user => {
      const userPhone = normalizePhoneNumber(user.telefono || '');
      return normalizedPhones.includes(userPhone);
    });

    return {
      phoneContact: {
        id: contact.id,
        name: contact.name || 'Sin nombre',
        phoneNumbers: normalizedPhones,
        imageAvailable: contact.imageAvailable || false,
      },
      minymolUser: platformUser,  // undefined si no est√° en la plataforma
    };
  });
```

### Ordenamiento de Resultados

```typescript
.sort((a, b) => {
  // 1. Usuarios que S√ç puedes chatear primero
  const canChatA = a.platformUser?.canChat !== false;
  const canChatB = b.platformUser?.canChat !== false;
  
  if (canChatA && !canChatB) return -1;
  if (!canChatA && canChatB) return 1;
  
  // 2. Dentro de cada grupo, usuarios registrados primero
  if (a.platformUser && !b.platformUser) return -1;
  if (!a.platformUser && b.platformUser) return 1;
  
  // 3. Por √∫ltimo, orden alfab√©tico
  return a.phoneContact.name.localeCompare(b.phoneContact.name);
});
```

---

## üö´ L√≥gica de Permisos de Chat (canChat)

### Concepto

El campo `canChat` determina si el usuario actual puede iniciar una conversaci√≥n con ese contacto, bas√°ndose en sus roles.

### Implementaci√≥n en el Backend (API)

```typescript
// Ejemplo: Endpoint GET /api/chat/contacts
router.get('/contacts', authenticateToken, async (req, res) => {
  const currentUserRole = req.user.rol; // 'proveedor' o 'comerciante'
  
  // Obtener todos los usuarios potenciales
  const users = await getUsersFromDatabase();
  
  // Aplicar l√≥gica de canChat seg√∫n roles
  const contacts = users.map(user => ({
    userId: user.id,
    nombre: user.nombre,
    telefono: user.telefono,
    rol: user.rol,
    logo_url: user.logo_url,
    canChat: canChatBetweenRoles(currentUserRole, user.rol)
  }));
  
  res.json({ contacts });
});
```

### Funci√≥n de Validaci√≥n

```typescript
function canChatBetweenRoles(
  currentUserRole: string, 
  targetUserRole: string
): boolean {
  // Matriz de permisos de chat
  const chatPermissions: Record<string, string[]> = {
    'proveedor': ['comerciante'],      // Proveedores solo chatean con comerciantes
    'comerciante': ['proveedor'],      // Comerciantes solo chatean con proveedores
    'admin': ['proveedor', 'comerciante', 'admin']  // Admin con todos
  };
  
  const allowedRoles = chatPermissions[currentUserRole] || [];
  return allowedRoles.includes(targetUserRole);
}
```

### Ejemplo de Implementaci√≥n por App

#### App de Mayoristas (Proveedores)
```typescript
// Backend: Proveedor autenticado
if (req.user.rol === 'proveedor') {
  contact.canChat = targetUser.rol === 'comerciante';
}
```

#### App de Minoristas (Comerciantes)
```typescript
// Backend: Comerciante autenticado
if (req.user.rol === 'comerciante') {
  contact.canChat = targetUser.rol === 'proveedor';
}
```

### Manejo en el Frontend

```typescript
const handleContactPress = (matched: MatchedContact) => {
  if (matched.platformUser) {
    // Verificar si se puede chatear
    if (matched.platformUser.canChat === false) {
      const roleMessage = 
        matched.platformUser.rol === 'proveedor' 
          ? 'No puedes chatear con otros proveedores'
        : matched.platformUser.rol === 'comerciante'
          ? 'No puedes chatear con otros comerciantes'
        : 'No puedes chatear con este usuario';
      
      Alert.alert('Chat no disponible', roleMessage);
      return;
    }
    
    // Iniciar chat
    onSelectContact(
      matched.platformUser.userId,
      matched.platformUser.nombre,
      matched.platformUser.logo_url
    );
  } else {
    // Invitar contacto no registrado
    handleInviteContact(matched.phoneContact);
  }
};
```

---

## üíæ Sistema de Cach√© con AsyncStorage

### Claves de Almacenamiento

```typescript
const CONTACTS_CACHE_KEY = '@app_matched_contacts';
const CONTACTS_TIMESTAMP_KEY = '@app_contacts_timestamp';
const CACHE_EXPIRATION_TIME = 24 * 60 * 60 * 1000; // 24 horas
```

### Guardar en Cach√©

```typescript
const saveToCache = async (contacts: MatchedContact[]) => {
  try {
    await Promise.all([
      AsyncStorage.setItem(CONTACTS_CACHE_KEY, JSON.stringify(contacts)),
      AsyncStorage.setItem(CONTACTS_TIMESTAMP_KEY, Date.now().toString()),
    ]);
    console.log('üíæ Contactos guardados en cach√©');
  } catch (error) {
    console.error('Error guardando cach√©:', error);
  }
};
```

### Leer desde Cach√©

```typescript
const loadFromCache = async (): Promise<MatchedContact[] | null> => {
  try {
    const [cachedContacts, cachedTimestamp] = await Promise.all([
      AsyncStorage.getItem(CONTACTS_CACHE_KEY),
      AsyncStorage.getItem(CONTACTS_TIMESTAMP_KEY),
    ]);

    if (!cachedContacts || !cachedTimestamp) {
      return null;
    }

    const timestamp = parseInt(cachedTimestamp, 10);
    const now = Date.now();

    // Verificar expiraci√≥n
    if (now - timestamp > CACHE_EXPIRATION_TIME) {
      console.log('‚è∞ Cach√© expirado');
      return null;
    }

    return JSON.parse(cachedContacts);
  } catch (error) {
    console.error('Error leyendo cach√©:', error);
    return null;
  }
};
```

### Actualizaci√≥n en Background

```typescript
const updateContactsInBackground = async () => {
  console.log('üîÑ Actualizando contactos en background...');
  
  try {
    // No mostrar loading, solo actualizar silenciosamente
    const { status } = await Contacts.getPermissionsAsync();
    if (status !== 'granted') return;

    // Obtener datos frescos
    const [contactsResult, platformUsers] = await Promise.all([
      Contacts.getContactsAsync({ fields: [Contacts.Fields.PhoneNumbers] }),
      ChatService.getAvailableContacts(),
    ]);

    // Hacer matching
    const matched = compareAndMatch(contactsResult.data, platformUsers);

    // Actualizar UI y cach√©
    setMatchedContacts(matched);
    await saveToCache(matched);
    
    console.log('‚úÖ Contactos actualizados en background');
  } catch (error) {
    console.error('Error en actualizaci√≥n background:', error);
  }
};
```

---

## üì§ Invitaci√≥n de Contactos No Registrados

### Funci√≥n de Invitaci√≥n

```typescript
const handleInviteContact = (contact: PhoneContact) => {
  const message = `¬°Hola ${contact.name}! Te invito a usar [App Name], la mejor plataforma para [tu prop√≥sito]. Desc√°rgala aqu√≠: https://tuapp.com/descargar`;
  
  const phoneNumber = contact.phoneNumbers[0];
  
  // URL de WhatsApp
  const whatsappUrl = Platform.select({
    ios: `whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`,
    android: `whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`,
  });

  Linking.canOpenURL(whatsappUrl!)
    .then(supported => {
      if (supported) {
        Linking.openURL(whatsappUrl!);
      } else {
        // Fallback a SMS
        const smsUrl = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
        Linking.openURL(smsUrl);
      }
    })
    .catch(err => {
      Alert.alert('Error', 'No se pudo abrir WhatsApp o SMS.');
    });
};
```

---

## üé® Renderizado de Contactos

### Contacto con Usuario Registrado

```typescript
{isOnPlatform && !cannotChat && (
  <View style={styles.chatButton}>
    <Ionicons name="chatbubble-ellipses" size={20} color={COLORS.primary} />
    <Text style={styles.chatButtonText}>Chatear</Text>
  </View>
)}
```

### Contacto NO Registrado

```typescript
{!isOnPlatform && (
  <View style={styles.inviteButton}>
    <Ionicons name="person-add-outline" size={20} color={COLORS.secondaryText} />
    <Text style={styles.inviteButtonText}>Invitar</Text>
  </View>
)}
```

### Contacto Restringido (canChat = false)

```typescript
{cannotChat && (
  <Text style={[styles.contactPhone, { color: '#dc2626', fontStyle: 'italic' }]}>
    No puedes chatear con este tipo de usuario
  </Text>
)}
```

---

## üîç B√∫squeda y Filtrado

```typescript
const [searchQuery, setSearchQuery] = useState('');

const filteredContacts = matchedContacts.filter(matched => 
  matched.phoneContact.name.toLowerCase().includes(searchQuery.toLowerCase())
);

// Buscador UI
<TextInput
  style={styles.searchInput}
  placeholder="Buscar contacto..."
  value={searchQuery}
  onChangeText={setSearchQuery}
  autoCapitalize="none"
/>
```

---

## üé≠ Animaciones

### Entrada desde Abajo

```typescript
const [slideAnim] = useState(new Animated.Value(SCREEN_HEIGHT));

// Al abrir modal
Animated.spring(slideAnim, {
  toValue: 0,
  useNativeDriver: true,
  tension: 65,
  friction: 11,
}).start();

// Al cerrar modal
Animated.timing(slideAnim, {
  toValue: SCREEN_HEIGHT,
  duration: 250,
  useNativeDriver: true,
}).start();
```

---

## üß™ Testing y Debug

### Logs Importantes

```typescript
console.log('üì¶ Contactos cargados desde cach√©');
console.log('‚è∞ Cach√© expirado, recargando...');
console.log('üíæ Contactos guardados en cach√©');
console.log('üîÑ Actualizando contactos en background...');
console.log('‚úÖ Contactos actualizados en background');
```

### Verificaci√≥n de Permisos

```typescript
const { status } = await Contacts.getPermissionsAsync();
console.log('Estado de permisos:', status); // 'granted', 'denied', 'undetermined'
```

### Debug de Matching

```typescript
console.log('Total contactos tel√©fono:', phoneContacts.length);
console.log('Total usuarios plataforma:', platformUsers.length);
console.log('Total coincidencias:', matched.length);
console.log('Usuarios con canChat=true:', 
  matched.filter(m => m.platformUser?.canChat === true).length
);
```

---

## ‚ö†Ô∏è Consideraciones y Mejores Pr√°cticas

### 1. **Privacidad y Permisos**
- Siempre explicar por qu√© necesitas los permisos
- Ofrecer opci√≥n de ir a Configuraci√≥n si se niegan
- No solicitar permisos hasta que sea necesario

### 2. **Rendimiento**
- Usar cach√© para evitar lecturas innecesarias
- Actualizar en background mientras se muestra cach√©
- Limitar campos solicitados a Contacts API

### 3. **UX**
- Mostrar loading solo en primera carga
- Permitir cerrar modal con overlay tap
- Ordenar contactos l√≥gicamente (registrados primero)

### 4. **Normalizaci√≥n de N√∫meros**
- Ajustar c√≥digo de pa√≠s seg√∫n regi√≥n
- Manejar formatos internacionales
- Validar antes de comparar

### 5. **Errores Comunes**
- No normalizar n√∫meros ‚Üí matching falla
- No verificar permisos ‚Üí crash
- No manejar cach√© ‚Üí rendimiento pobre
- No validar canChat ‚Üí UX confusa

---

## üìä Diagrama de Flujo Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    USUARIO ABRE MODAL                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ¬øExiste cach√© v√°lido? (< 24h)                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ S√ç               ‚îÇ NO
                     ‚Üì                  ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ Mostrar cach√©      ‚îÇ  ‚îÇ Mostrar loading  ‚îÇ
        ‚îÇ inmediatamente     ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
                 ‚îÇ                       ‚Üì
                 ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ         ‚îÇ Solicitar permisos          ‚îÇ
                 ‚îÇ         ‚îÇ (Contacts.requestPermissions)‚îÇ
                 ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ                   ‚îÇ
                 ‚îÇ                   ‚Üì
                 ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ         ‚îÇ ¬øPermisos concedidos?       ‚îÇ
                 ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ                ‚îÇ S√ç           ‚îÇ NO
                 ‚îÇ                ‚Üì              ‚Üì
                 ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ    ‚îÇ Obtener contactos ‚îÇ  ‚îÇ Mostrar msg ‚îÇ
                 ‚îÇ    ‚îÇ del tel√©fono      ‚îÇ  ‚îÇ de permisos ‚îÇ
                 ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ          ‚îÇ
                 ‚îÇ          ‚Üì
                 ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ    ‚îÇ Obtener usuarios de   ‚îÇ
                 ‚îÇ    ‚îÇ plataforma (API)      ‚îÇ
                 ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ          ‚îÇ
                 ‚îÇ          ‚Üì
                 ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ    ‚îÇ Normalizar y comparar ‚îÇ
                 ‚îÇ    ‚îÇ n√∫meros de tel√©fono   ‚îÇ
                 ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ          ‚îÇ
                 ‚îÇ          ‚Üì
                 ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ    ‚îÇ Aplicar l√≥gica        ‚îÇ
                 ‚îÇ    ‚îÇ canChat (roles)       ‚îÇ
                 ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ          ‚îÇ
                 ‚îÇ          ‚Üì
                 ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ    ‚îÇ Ordenar resultados    ‚îÇ
                 ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ          ‚îÇ
                 ‚îÇ          ‚Üì
                 ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ    ‚îÇ Guardar en cach√©      ‚îÇ
                 ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ          ‚îÇ
                 ‚Üì          ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ Actualizar contactos en background ‚îÇ
        ‚îÇ (proceso silencioso)               ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ USUARIO VE LISTA DE CONTACTOS      ‚îÇ
        ‚îÇ (puede buscar, filtrar, seleccionar)‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ USUARIO TOCA UN CONTACTO           ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ ¬øUsuario est√° en plataforma? ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ S√ç           ‚îÇ NO
               ‚Üì              ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ ¬øcanChat=true?   ‚îÇ  ‚îÇ Invitar v√≠a    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ WhatsApp/SMS   ‚îÇ
        ‚îÇ S√ç   ‚îÇ NO       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì      ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Abrir ‚îÇ ‚îÇ Mostrar alerta  ‚îÇ
    ‚îÇ Chat  ‚îÇ ‚îÇ "No disponible" ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Checklist de Implementaci√≥n

- [ ] Instalar librer√≠as necesarias (`expo-contacts`, `@react-native-async-storage/async-storage`)
- [ ] Configurar permisos en `AndroidManifest.xml` y `Info.plist`
- [ ] Implementar solicitud de permisos en runtime
- [ ] Crear funci√≥n de normalizaci√≥n de n√∫meros de tel√©fono
- [ ] Implementar endpoint API para obtener usuarios con `canChat`
- [ ] Configurar l√≥gica de roles y permisos de chat en backend
- [ ] Implementar sistema de cach√© con AsyncStorage
- [ ] Crear comparaci√≥n y matching de contactos
- [ ] Implementar actualizaci√≥n en background
- [ ] Agregar b√∫squeda y filtrado de contactos
- [ ] Implementar invitaci√≥n v√≠a WhatsApp/SMS
- [ ] Agregar animaciones de entrada/salida
- [ ] Testear con diferentes tipos de usuarios (roles)
- [ ] Validar normalizaci√≥n con n√∫meros internacionales
- [ ] Probar rendimiento con muchos contactos (>1000)

---

## üìö Recursos Adicionales

- [Expo Contacts Documentation](https://docs.expo.dev/versions/latest/sdk/contacts/)
- [AsyncStorage Documentation](https://react-native-async-storage.github.io/async-storage/)
- [React Native Linking](https://reactnative.dev/docs/linking)
- [React Native Animated](https://reactnative.dev/docs/animated)

---

## ü§ù Adaptaci√≥n por App

### Para App de Proveedores (Mayoristas)
```typescript
// Backend: canChat logic
canChat: targetUser.rol === 'comerciante'

// Mensaje de error
"No puedes chatear con otros proveedores"
```

### Para App de Comerciantes (Minoristas)
```typescript
// Backend: canChat logic
canChat: targetUser.rol === 'proveedor'

// Mensaje de error
"No puedes chatear con otros comerciantes"
```

**Nota:** Ajustar mensajes y l√≥gica de `canChat` seg√∫n el rol del usuario autenticado en cada aplicaci√≥n.

---

## üêõ Troubleshooting

### Problema: No se encuentran coincidencias
**Soluci√≥n:** Verificar normalizaci√≥n de n√∫meros. Asegurar que el c√≥digo de pa√≠s sea consistente.

### Problema: Cach√© no se actualiza
**Soluci√≥n:** Verificar timestamp y tiempo de expiraci√≥n. Borrar cach√© manualmente en desarrollo.

### Problema: Permisos se niegan autom√°ticamente
**Soluci√≥n:** Usuario debe ir a Configuraci√≥n del sistema y habilitar permisos manualmente.

### Problema: canChat no funciona correctamente
**Soluci√≥n:** Verificar que el backend env√≠e el campo `canChat` correctamente seg√∫n roles.

---

**Versi√≥n del documento:** 1.0  
**√öltima actualizaci√≥n:** Octubre 2025  
**Autor:** Minymol Development Team
