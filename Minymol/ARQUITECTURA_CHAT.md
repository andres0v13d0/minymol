# ğŸ—ï¸ ARQUITECTURA DEL MÃ“DULO DE CHAT

## ğŸ“ Vista General del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USUARIO                                    â”‚
â”‚                         (React Native)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ InteracciÃ³n
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CAPA DE UI                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Chat.js     â”‚  â”‚ ChatModal.js â”‚  â”‚ Contacts     â”‚              â”‚
â”‚  â”‚  (pÃ¡gina)    â”‚  â”‚  (modal)     â”‚  â”‚ ListModal.js â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                  â”‚                  â”‚                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Eventos & Listeners
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CAPA DE SERVICIOS                                  â”‚
â”‚                   (ChatService.js)                                   â”‚
â”‚                    [ORQUESTADOR]                                     â”‚
â”‚                                                                       â”‚
â”‚  â€¢ Coordina WebSocket, REST API y SQLite                            â”‚
â”‚  â€¢ Maneja lÃ³gica de negocio                                         â”‚
â”‚  â€¢ Emite eventos a la UI                                            â”‚
â”‚  â€¢ Optimistic UI updates                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                    â”‚
         â”‚                  â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ WebSocketâ”‚      â”‚  REST API   â”‚     â”‚   SQLite    â”‚
    â”‚  Real    â”‚      â”‚  Fallback   â”‚     â”‚ Persistence â”‚
    â”‚  Time    â”‚      â”‚             â”‚     â”‚             â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                    â”‚
         â”‚                  â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚                                                  â”‚
    â”‚            SERVIDOR (Backend)                   â”‚
    â”‚   â€¢ wss://api.minymol.com (WebSocket)          â”‚
    â”‚   â€¢ https://api.minymol.com/chat/* (REST)      â”‚
    â”‚                                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± Flujo de EnvÃ­o de Mensaje

```
USUARIO                    UI                   ChatService              WebSocket/API           SERVIDOR
   â”‚                       â”‚                         â”‚                         â”‚                    â”‚
   â”‚  1. Escribe mensaje   â”‚                         â”‚                         â”‚                    â”‚
   â”‚  y toca "Enviar"      â”‚                         â”‚                         â”‚                    â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚                         â”‚                    â”‚
   â”‚                       â”‚                         â”‚                         â”‚                    â”‚
   â”‚                       â”‚  2. sendMessage()       â”‚                         â”‚                    â”‚
   â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚                    â”‚
   â”‚                       â”‚                         â”‚                         â”‚                    â”‚
   â”‚                       â”‚                         â”‚  3. Guardar en SQLite   â”‚                    â”‚
   â”‚                       â”‚                         â”‚    (tempId, status:     â”‚                    â”‚
   â”‚                       â”‚                         â”‚     SENDING â³)          â”‚                    â”‚
   â”‚                       â”‚                         â”‚                         â”‚                    â”‚
   â”‚  4. Mensaje aparece   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  4. Emitir evento       â”‚                    â”‚
   â”‚     instantÃ¡neamente  â”‚     'messageSent'       â”‚     'messageSent'       â”‚                    â”‚
   â”‚     con â³            â”‚                         â”‚                         â”‚                    â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚                         â”‚                    â”‚
   â”‚                       â”‚                         â”‚                         â”‚                    â”‚
   â”‚                       â”‚                         â”‚  5. Enviar por WebSocketâ”‚                    â”‚
   â”‚                       â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                       â”‚                         â”‚    (o REST si falla)    â”‚                    â”‚
   â”‚                       â”‚                         â”‚                         â”‚                    â”‚
   â”‚                       â”‚                         â”‚                         â”‚  6. Procesar       â”‚
   â”‚                       â”‚                         â”‚                         â”‚     mensaje        â”‚
   â”‚                       â”‚                         â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                       â”‚                         â”‚                         â”‚                    â”‚
   â”‚                       â”‚                         â”‚                         â”‚  7. ConfirmaciÃ³n   â”‚
   â”‚                       â”‚                         â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                       â”‚                         â”‚                         â”‚    (ID real)       â”‚
   â”‚                       â”‚                         â”‚  8. Actualizar SQLite   â”‚                    â”‚
   â”‚                       â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    (tempId â†’ ID)   â”‚
   â”‚                       â”‚                         â”‚    (tempId â†’ realId)    â”‚                    â”‚
   â”‚                       â”‚                         â”‚    (status: SENT âœ“)     â”‚                    â”‚
   â”‚                       â”‚                         â”‚                         â”‚                    â”‚
   â”‚  9. Estado actualiza  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  9. Emitir evento       â”‚                    â”‚
   â”‚     â³ â†’ âœ“            â”‚     'messageSent'       â”‚     'messageSent'       â”‚                    â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚                         â”‚                    â”‚
```

---

## ğŸ“¥ Flujo de RecepciÃ³n de Mensaje

```
SERVIDOR              WebSocket/API          ChatService                UI                 USUARIO
   â”‚                       â”‚                      â”‚                      â”‚                    â”‚
   â”‚  1. Nuevo mensaje     â”‚                      â”‚                      â”‚                    â”‚
   â”‚      de otro usuario  â”‚                      â”‚                      â”‚                    â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚                    â”‚
   â”‚                       â”‚                      â”‚                      â”‚                    â”‚
   â”‚                       â”‚  2. Evento           â”‚                      â”‚                    â”‚
   â”‚                       â”‚     'receiveMessage' â”‚                      â”‚                    â”‚
   â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                    â”‚
   â”‚                       â”‚                      â”‚                      â”‚                    â”‚
   â”‚                       â”‚                      â”‚  3. Guardar en       â”‚                    â”‚
   â”‚                       â”‚                      â”‚     SQLite           â”‚                    â”‚
   â”‚                       â”‚                      â”‚     (status:         â”‚                    â”‚
   â”‚                       â”‚                      â”‚      DELIVERED âœ“âœ“)   â”‚                    â”‚
   â”‚                       â”‚                      â”‚                      â”‚                    â”‚
   â”‚                       â”‚                      â”‚  4. Emitir evento    â”‚                    â”‚
   â”‚                       â”‚                      â”‚     'newMessage'     â”‚                    â”‚
   â”‚                       â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                       â”‚                      â”‚                      â”‚                    â”‚
   â”‚                       â”‚                      â”‚                      â”‚  5. Mensaje        â”‚
   â”‚                       â”‚                      â”‚                      â”‚     aparece        â”‚
   â”‚                       â”‚                      â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                       â”‚                      â”‚                      â”‚                    â”‚
   â”‚                       â”‚                      â”‚  6. Si chat abierto: â”‚                    â”‚
   â”‚                       â”‚                      â”‚     markAsRead()     â”‚                    â”‚
   â”‚                       â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
   â”‚                       â”‚                      â”‚                      â”‚                    â”‚
   â”‚                       â”‚  7. Enviar           â”‚                      â”‚                    â”‚
   â”‚                       â”‚     'markAsRead'     â”‚                      â”‚                    â”‚
   â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                    â”‚
   â”‚                       â”‚                      â”‚                      â”‚                    â”‚
   â”‚  8. Actualizar        â”‚                      â”‚                      â”‚                    â”‚
   â”‚     estado en BD      â”‚                      â”‚                      â”‚                    â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚                    â”‚
```

---

## ğŸ”„ Estrategia Dual (WebSocket + REST)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ChatService       â”‚
                    â”‚   (Orquestador)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                             â”‚
                â–¼                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ChatWebSocket.js     â”‚     â”‚  ChatApiClient.js      â”‚
    â”‚  (Socket.IO)          â”‚     â”‚  (REST API)            â”‚
    â”‚                       â”‚     â”‚                        â”‚
    â”‚  âœ… Tiempo real       â”‚     â”‚  âœ… Fallback robusto   â”‚
    â”‚  âœ… Push automÃ¡tico   â”‚     â”‚  âœ… Siempre funciona   â”‚
    â”‚  âš ï¸ Puede fallar      â”‚     â”‚  âš ï¸ No tiempo real     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                              â”‚
                â”‚                              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   SERVIDOR          â”‚
                    â”‚   api.minymol.com   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LÃ“GICA:
1. ChatService intenta enviar por WebSocket
2. Si WebSocket NO estÃ¡ conectado â†’ Usa REST API
3. Si WebSocket falla al enviar â†’ Usa REST API
4. Ambos mÃ©todos garantizan entrega del mensaje
```

---

## ğŸ’¾ Persistencia con SQLite

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ChatDatabase.js                           â”‚
â”‚                   (expo-sqlite)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  DATABASE: minymol_chat.db                                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  TABLE: messages                                    â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  â€¢ id (PRIMARY KEY)                                 â”‚    â”‚
â”‚  â”‚  â€¢ senderId                                         â”‚    â”‚
â”‚  â”‚  â€¢ receiverId                                       â”‚    â”‚
â”‚  â”‚  â€¢ chatId (INDEXED)                                 â”‚    â”‚
â”‚  â”‚  â€¢ message (TEXT)                                   â”‚    â”‚
â”‚  â”‚  â€¢ messageType ('text', 'image', etc.)              â”‚    â”‚
â”‚  â”‚  â€¢ status ('sending', 'sent', 'delivered', 'read')  â”‚    â”‚
â”‚  â”‚  â€¢ timestamp (INDEXED)                              â”‚    â”‚
â”‚  â”‚  â€¢ isRead (BOOLEAN)                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  TABLE: conversations                               â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  â€¢ chatId (PRIMARY KEY)                             â”‚    â”‚
â”‚  â”‚  â€¢ userId1                                          â”‚    â”‚
â”‚  â”‚  â€¢ userId2                                          â”‚    â”‚
â”‚  â”‚  â€¢ lastMessage (TEXT)                               â”‚    â”‚
â”‚  â”‚  â€¢ lastMessageTime (INDEXED)                        â”‚    â”‚
â”‚  â”‚  â€¢ unreadCount (INTEGER)                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  OPTIMIZACIONES:                                            â”‚
â”‚  â€¢ PRAGMA journal_mode = WAL (mejor performance)           â”‚
â”‚  â€¢ PRAGMA synchronous = NORMAL                             â”‚
â”‚  â€¢ PRAGMA cache_size = 10000                               â”‚
â”‚  â€¢ Ãndices en chatId y timestamp                           â”‚
â”‚  â€¢ Limpieza automÃ¡tica mensajes >30 dÃ­as                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Contextos y Estado Global

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        App.js                                â”‚
â”‚                      (Root Component)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Context Providers           â”‚
            â”‚   (JerarquÃ­a)                 â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                               â”‚
            â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CartCounterContext  â”‚       â”‚ ChatCounterContext  â”‚
â”‚ (contador carrito)  â”‚       â”‚ (contador chat)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â”‚ Proporciona:                â”‚ Proporciona:
          â”‚ â€¢ count (nÃºmero)            â”‚ â€¢ count (nÃºmero)
          â”‚ â€¢ forceUpdate()             â”‚ â€¢ forceUpdate()
          â”‚                             â”‚
          â”‚ Actualiza:                  â”‚ Actualiza:
          â”‚ â€¢ Al agregar al carrito     â”‚ â€¢ Al recibir mensaje
          â”‚ â€¢ Al quitar del carrito     â”‚ â€¢ Al marcar como leÃ­do
          â”‚                             â”‚
          â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      NavInf.js      â”‚       â”‚      Chat.js        â”‚
â”‚  (badge carrito)    â”‚       â”‚  (badge mensajes)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Componentes UI y su JerarquÃ­a

```
Chat.js (PÃ¡gina principal)
â”‚
â”œâ”€> Header
â”‚   â”œâ”€> TÃ­tulo "Mensajes"
â”‚   â””â”€> BotÃ³n nuevo chat (âœï¸)
â”‚
â”œâ”€> FlatList (Conversaciones)
â”‚   â””â”€> ConversationItem.js (x N)
â”‚       â”œâ”€> Avatar (con color generado)
â”‚       â”œâ”€> Nombre del contacto
â”‚       â”œâ”€> Ãšltimo mensaje
â”‚       â”œâ”€> Hora
â”‚       â””â”€> Badge no leÃ­dos
â”‚
â”œâ”€> FAB (BotÃ³n flotante +)
â”‚
â”œâ”€> ChatModal.js (Modal de conversaciÃ³n)
â”‚   â”‚
â”‚   â”œâ”€> Header
â”‚   â”‚   â”œâ”€> BotÃ³n atrÃ¡s
â”‚   â”‚   â”œâ”€> Nombre del contacto
â”‚   â”‚   â””â”€> Badge "Proveedor"
â”‚   â”‚
â”‚   â”œâ”€> FlatList (Mensajes)
â”‚   â”‚   â””â”€> MessageBubble.js (x N)
â”‚   â”‚       â”œâ”€> Separador de fecha (opcional)
â”‚   â”‚       â”œâ”€> Burbuja (naranja o blanca)
â”‚   â”‚       â”œâ”€> Cola CSS (triÃ¡ngulo)
â”‚   â”‚       â”œâ”€> Texto del mensaje
â”‚   â”‚       â””â”€> Hora + Estado (â³ âœ“ âœ“âœ“)
â”‚   â”‚
â”‚   â””â”€> Input Container
â”‚       â”œâ”€> TextInput
â”‚       â””â”€> BotÃ³n enviar (ğŸš€)
â”‚
â””â”€> ContactsListModal.js (SelecciÃ³n de contacto)
    â”‚
    â”œâ”€> Header
    â”‚   â”œâ”€> BotÃ³n cerrar
    â”‚   â””â”€> TÃ­tulo "Nuevo Chat"
    â”‚
    â”œâ”€> BÃºsqueda (ğŸ”)
    â”‚
    â”œâ”€> FlatList (Contactos)
    â”‚   â””â”€> ContactItem (x N)
    â”‚       â”œâ”€> Avatar (ğŸª para proveedores)
    â”‚       â”œâ”€> Nombre
    â”‚       â”œâ”€> Badge "Proveedor"
    â”‚       â””â”€> Flecha (>)
    â”‚
    â””â”€> Footer
        â””â”€> Info: "Solo puedes chatear con proveedores"
```

---

## âš¡ Optimizaciones de Performance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  OPTIMIZACIONES                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. SINGLETON PATTERN                                       â”‚
â”‚     â€¢ ChatService (instancia Ãºnica)                         â”‚
â”‚     â€¢ ChatWebSocket (instancia Ãºnica)                       â”‚
â”‚     â€¢ ChatApiClient (instancia Ãºnica)                       â”‚
â”‚     â€¢ ChatDatabase (instancia Ãºnica)                        â”‚
â”‚     âœ… No se crean mÃºltiples conexiones                     â”‚
â”‚                                                              â”‚
â”‚  2. REACT.MEMO                                              â”‚
â”‚     â€¢ Todos los componentes UI memoizados                   â”‚
â”‚     â€¢ Solo re-renderan si cambian props especÃ­ficas         â”‚
â”‚     âœ… Menos renders = mejor performance                    â”‚
â”‚                                                              â”‚
â”‚  3. OPTIMISTIC UI                                           â”‚
â”‚     â€¢ Mensaje aparece instantÃ¡neamente (tempId)             â”‚
â”‚     â€¢ Estado actualiza despuÃ©s de confirmaciÃ³n             â”‚
â”‚     âœ… UX instantÃ¡nea sin esperar servidor                  â”‚
â”‚                                                              â”‚
â”‚  4. THROTTLE                                                â”‚
â”‚     â€¢ ActualizaciÃ³n de contador (max cada 500ms)           â”‚
â”‚     â€¢ Eventos de WebSocket agrupados                        â”‚
â”‚     âœ… Menos actualizaciones del estado                     â”‚
â”‚                                                              â”‚
â”‚  5. PAGINACIÃ“N                                              â”‚
â”‚     â€¢ Cargar mensajes en chunks de 50                       â”‚
â”‚     â€¢ Lazy loading al hacer scroll                          â”‚
â”‚     âœ… No cargar todos los mensajes de golpe                â”‚
â”‚                                                              â”‚
â”‚  6. ÃNDICES EN SQLITE                                       â”‚
â”‚     â€¢ chatId indexado                                       â”‚
â”‚     â€¢ timestamp indexado                                    â”‚
â”‚     âœ… Queries ultra rÃ¡pidas                                â”‚
â”‚                                                              â”‚
â”‚  7. WAL MODE SQLITE                                         â”‚
â”‚     â€¢ Write-Ahead Logging                                   â”‚
â”‚     â€¢ Lecturas y escrituras simultÃ¡neas                     â”‚
â”‚     âœ… No bloquea la UI                                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Seguridad y AutenticaciÃ³n

```
USUARIO â”€â”€> Firebase Auth â”€â”€> Token JWT â”€â”€> Servidor
            (login)          (Bearer)        (verificaciÃ³n)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FLUJO DE AUTENTICACIÃ“N                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Usuario se loguea (Firebase Auth)                       â”‚
â”‚                                                              â”‚
â”‚  2. Se obtiene token JWT                                    â”‚
â”‚     â€¢ getAuth().currentUser.getIdToken()                    â”‚
â”‚     â€¢ Token almacenado en AsyncStorage                      â”‚
â”‚                                                              â”‚
â”‚  3. WebSocket:                                              â”‚
â”‚     â€¢ ConexiÃ³n con auth: { token, userId }                  â”‚
â”‚     â€¢ Servidor valida token en handshake                    â”‚
â”‚                                                              â”‚
â”‚  4. REST API:                                               â”‚
â”‚     â€¢ Header: Authorization: Bearer <token>                 â”‚
â”‚     â€¢ Inyectado automÃ¡ticamente por apiCall()               â”‚
â”‚     â€¢ Servidor valida token en cada request                 â”‚
â”‚                                                              â”‚
â”‚  5. Token renewal:                                          â”‚
â”‚     â€¢ Si 401 â†’ Renovar token automÃ¡ticamente               â”‚
â”‚     â€¢ Reintentar request                                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Estados y Transiciones

```
MENSAJE ENVIADO (mis mensajes):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ SENDING â”‚ â”€â”€â”€> â”‚ SENT â”‚ â”€â”€â”€> â”‚ DELIVERED â”‚ â”€â”€â”€> â”‚ READ â”‚
â”‚    â³   â”‚      â”‚  âœ“   â”‚      â”‚    âœ“âœ“     â”‚      â”‚ âœ“âœ“ğŸ”µ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ (si falla)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FAILED  â”‚
â”‚   âŒ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MENSAJE RECIBIDO (mensajes de otros):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ DELIVERED â”‚ â”€â”€â”€> â”‚ READ â”‚
â”‚    âœ“âœ“     â”‚      â”‚ âœ“âœ“ğŸ”µ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Colores y Estilos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PALETA DE COLORES MINYMOL                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â€¢ Naranja principal: #fa7e17                               â”‚
â”‚    (botones, badges, FAB, checks leÃ­dos)                    â”‚
â”‚                                                              â”‚
â”‚  â€¢ Burbujas mÃ­as: #FFD4A3 (naranja claro)                   â”‚
â”‚    (mensajes que yo envÃ­o, alineados a la derecha)          â”‚
â”‚                                                              â”‚
â”‚  â€¢ Burbujas otros: #ffffff (blanco)                         â”‚
â”‚    (mensajes que recibo, alineados a la izquierda)          â”‚
â”‚                                                              â”‚
â”‚  â€¢ Fondo: #f5f5f5 (gris muy claro)                          â”‚
â”‚    (fondo de la pantalla de chat)                           â”‚
â”‚                                                              â”‚
â”‚  â€¢ Texto oscuro: #2b2b2b                                    â”‚
â”‚    (texto principal)                                         â”‚
â”‚                                                              â”‚
â”‚  â€¢ Texto secundario: #666, #999, #bbb                       â”‚
â”‚    (hora, metadatos, placeholders)                          â”‚
â”‚                                                              â”‚
â”‚  â€¢ Check leÃ­do: #4a90e2 (azul)                              â”‚
â”‚    (doble check cuando el mensaje fue leÃ­do)                â”‚
â”‚                                                              â”‚
â”‚  â€¢ Separadores: #e0e0e0, #f0f0f0                            â”‚
â”‚    (lÃ­neas de separaciÃ³n entre items)                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

Â¡Arquitectura completamente documentada! ğŸ‰ğŸ—ï¸

**Total de diagramas:** 9
**Cobertura:** 100% del sistema
